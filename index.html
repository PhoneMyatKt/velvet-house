<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velvet House - Business Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Pyidaungsu:wght@400;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', 'Pyidaungsu', sans-serif; 
            background-color: #fcfcfd; 
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .neo-card {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.02), 0 4px 6px -4px rgba(0, 0, 0, 0.02);
            box-sizing: border-box;
        }

        .bottom-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid #f1f5f9;
        }

        .nav-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-tab-btn {
            color: #4f46e5;
            transform: translateY(-2px);
        }

        .active-tab-btn .icon-bg {
            background: #f5f3ff;
        }

        .input-field {
            transition: all 0.2s;
            box-sizing: border-box; /* Ensures padding doesn't push width out */
            appearance: none;
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            border-color: #4f46e5 !important;
            background: #ffffff !important;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.06) !important;
        }

        .calc-result {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        #welcome-screen {
            background: #4f46e5;
        }

        .sync-indicator {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 99px;
            font-weight: 700;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="pb-32">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center text-center p-8 transition-transform duration-500 ease-in-out">
        <div class="w-24 h-24 bg-white/20 backdrop-blur-xl rounded-[32px] flex items-center justify-center mb-8 shadow-2xl border border-white/30">
            <span class="text-4xl font-black text-white">V</span>
        </div>
        <h1 class="text-3xl font-extrabold text-white mb-2">Velvet House</h1>
        <p class="text-indigo-100 text-xs mb-10 opacity-80">Management Suite</p>
        
        <div class="flex flex-col items-center gap-4 w-full max-w-xs">
            <div id="auth-status" class="text-white text-[10px] font-bold opacity-60 uppercase tracking-widest animate-pulse">Initializing Cloud...</div>
            <button id="start-btn" disabled onclick="startApp()" class="w-full bg-white text-indigo-600 font-extrabold py-5 rounded-3xl shadow-2xl active:scale-95 transition-all text-sm opacity-50 cursor-not-allowed">
                Connecting...
            </button>
        </div>
    </div>

    <!-- Header -->
    <header id="main-header" class="hidden sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-lg font-extrabold text-slate-900">Velvet House</h1>
            <div id="sync-status" class="sync-indicator bg-amber-50 text-amber-600 mt-1 inline-block">Syncing...</div>
        </div>
        <div id="live-date" class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter"></div>
    </header>

    <main id="main-content" class="hidden max-w-md mx-auto p-5 space-y-6">
        
        <!-- Tab 1: Input -->
        <section id="page-input" class="space-y-5 fade-in">
            <div class="neo-card rounded-[2.5rem] p-7 border-t-4 border-indigo-600">
                <div class="flex items-center justify-between mb-8">
                    <h2 id="input-title" class="text-sm font-bold text-slate-800">üìù ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏</h2>
                </div>

                <div class="space-y-5">
                    <input type="hidden" id="editId">
                    
                    <!-- Fixed UI Container for Date and Category -->
                    <div class="space-y-5">
                        <div class="w-full">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">·Äî·Ä±·Ä∑·ÄÖ·ÄΩ·Ä≤</label>
                            <input type="date" id="saleDate" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold text-slate-700 block">
                        </div>
                        <div class="w-full">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏</label>
                            <select id="pCategory" onchange="toggleFields()" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold text-slate-700 block">
                                <option value="perfume">Perfume</option>
                                <option value="cosmetic">Cosmetic</option>
                                <option value="other">Other Item</option>
                            </select>
                        </div>
                    </div>

                    <div class="w-full">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Ä°·Äô·Ää·Ä∫</label>
                        <input type="text" id="pName" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold text-slate-800 block" placeholder="·Ä°·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´">
                    </div>

                    <div id="perfume-extras" class="grid grid-cols-2 gap-4">
                        <div class="w-full">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Type</label>
                            <select id="pType" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold text-slate-700 block">
                                <option value="EDT">EDT</option>
                                <option value="EDP">EDP</option>
                                <option value="Extrait">Extrait</option>
                                <option value="Parfum">Parfum</option>
                            </select>
                        </div>
                        <div class="w-full">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">·ÄÜ·Ä≠·ÄØ·Äí·Ä∫ (Size)</label>
                            <select id="pSize" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold text-slate-700 block">
                                <option value="retail">Retail Box</option>
                                <option value="5ml">5ml Decant</option>
                                <option value="10ml">10ml Decant</option>
                                <option value="30ml">30ml Decant</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="w-full">
                            <label id="costLabel" class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="cPrice" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-bold text-slate-800 block" placeholder="0">
                        </div>
                        <div class="w-full">
                            <label id="saleLabel" class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="sPrice" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-bold text-indigo-600 block" placeholder="0">
                        </div>
                    </div>

                    <div class="w-full">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Risk Cover Money (·Ä°·Äï·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±)</label>
                        <input type="number" id="riskMoney" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-black text-indigo-600 block" value="0">
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button id="save-btn" onclick="addSale()" class="flex-1 bg-indigo-600 text-white font-extrabold py-4 rounded-2xl shadow-xl active:scale-95 transition-all">·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫</button>
                        <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden w-1/3 bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl">·Äô·Äï·Äº·ÄÑ·Ä∫·Äê·Ä±·Ä¨·Ä∑</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab 2: Daily Stats -->
        <section id="page-daily" class="hidden space-y-5 fade-in">
            <div class="neo-card p-3 rounded-2xl flex items-center justify-between gap-4 border-l-4 border-indigo-600">
                <span class="text-[10px] font-bold text-slate-400 uppercase ml-2">·Äî·Ä±·Ä∑·Äõ·ÄÄ·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´:</span>
                <input type="date" id="viewDate" onchange="renderAll()" class="bg-indigo-50 border-none text-[11px] font-black rounded-xl px-3 py-2.5 outline-none text-indigo-600">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="neo-card p-5 rounded-[2rem] bg-indigo-600 text-white border-none shadow-indigo-100 shadow-xl">
                    <p class="text-[9px] font-bold uppercase opacity-70 mb-1">Daily Profit (Deducted)</p>
                    <h3 class="text-xl font-black" id="day-total-profit">0 Ks</h3>
                </div>
                <div class="neo-card p-5 rounded-[2rem]">
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Daily Cost</p>
                    <h3 class="text-xl font-black text-slate-800" id="day-total-cost">0 Ks</h3>
                </div>
            </div>

            <div class="neo-card rounded-[2rem] overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                    <h3 class="text-[10px] font-extrabold text-slate-500 uppercase tracking-widest">Recent Activity</h3>
                    <button onclick="clearAllData()" class="text-[9px] text-rose-500 font-bold uppercase">Clear All</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-[9px] font-bold text-slate-400 uppercase bg-slate-50/30">
                            <tr>
                                <th class="px-6 py-4">Item</th>
                                <th class="px-6 py-4 text-right">Profit</th>
                                <th class="px-6 py-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="daily-table-body" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab 3: Monthly Reports -->
        <section id="page-monthly" class="hidden space-y-6 fade-in">
            <div id="monthly-container" class="space-y-6"></div>
        </section>

        <!-- Tab 4: Calculator -->
        <section id="page-calculator" class="hidden space-y-5 fade-in">
            <div class="neo-card rounded-[2.5rem] p-7 border-t-4 border-emerald-500">
                <h2 class="text-sm font-bold text-slate-800 mb-8">üßÆ ·Ä°·Äô·Äº·Äî·Ä∫·Äê·ÄΩ·ÄÄ·Ä∫·ÄÖ·ÄÄ·Ä∫</h2>
                <div class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏</label>
                        <select id="calcCategory" onchange="toggleCalcFields()" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold block">
                            <option value="perfume">Perfume</option>
                            <option value="cosmetic">Cosmetic</option>
                        </select>
                    </div>
                    <div id="calc-perfume-extras">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">·ÄÜ·Ä≠·ÄØ·Äí·Ä∫ (Size)</label>
                        <select id="calcSize" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-semibold block">
                            <option value="retail">Retail Box</option>
                            <option value="5ml">5ml Decant</option>
                            <option value="10ml">10ml Decant</option>
                            <option value="30ml">30ml Decant</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="w-full">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="calcCost" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-bold block" placeholder="0">
                        </div>
                        <div class="w-full">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="calcSale" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-bold text-indigo-600 block" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">·Ä°·Äï·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä± (Risk Money)</label>
                        <input type="number" id="calcRisk" class="input-field w-full mt-1.5 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3.5 outline-none font-black text-indigo-600 block" value="0">
                    </div>

                    <div id="calc-display" class="hidden calc-result rounded-3xl p-7 mt-6 text-center text-white">
                        <p class="text-[10px] font-bold uppercase opacity-70 mb-1">Expected Daily Profit</p>
                        <h2 class="text-2xl font-black" id="calc-result-text">0 Ks</h2>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-8">
                         <button onclick="calculateQuick()" class="bg-emerald-600 text-white font-extrabold py-5 rounded-2xl shadow-xl">·Äê·ÄΩ·ÄÄ·Ä∫·Äô·Ää·Ä∫</button>
                         <button onclick="resetCalc()" class="bg-slate-100 text-slate-500 font-bold py-5 rounded-2xl">Clear</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Navigation -->
    <nav id="main-nav" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bottom-nav z-50 px-3 py-2.5 flex justify-between rounded-[2.5rem] shadow-2xl">
        <button onclick="showTab('input')" id="btn-input" class="nav-item flex flex-col items-center gap-1 flex-1 active-tab-btn">
            <div class="icon-bg p-2 rounded-2xl"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg></div>
            <span class="text-[8px] font-extrabold uppercase tracking-widest">Input</span>
        </button>
        <button onclick="showTab('daily')" id="btn-daily" class="nav-item flex flex-col items-center gap-1 flex-1 text-slate-300">
            <div class="icon-bg p-2 rounded-2xl"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div>
            <span class="text-[8px] font-extrabold uppercase tracking-widest">Daily</span>
        </button>
        <button onclick="showTab('monthly')" id="btn-monthly" class="nav-item flex flex-col items-center gap-1 flex-1 text-slate-300">
            <div class="icon-bg p-2 rounded-2xl"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
            <span class="text-[8px] font-extrabold uppercase tracking-widest">Reports</span>
        </button>
        <button onclick="showTab('calculator')" id="btn-calculator" class="nav-item flex flex-col items-center gap-1 flex-1 text-slate-300">
            <div class="icon-bg p-2 rounded-2xl"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></div>
            <span class="text-[8px] font-extrabold uppercase tracking-widest">Calc</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZtpVewHYE5SHgmdSHUDYiMeuD9XuM8-Y",
            authDomain: "velvet-house.firebaseapp.com",
            projectId: "velvet-house",
            storageBucket: "velvet-house.firebasestorage.app",
            messagingSenderId: "909921771030",
            appId: "1:909921771030:web:399d30d6912a3685a59f37"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let salesData = [];
        const APP_ID = 'velvet-house-v3';

        signInAnonymously(auth).then(() => {
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'records', 'global');
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    salesData = snap.data().items || [];
                    renderAll();
                } else {
                    setDoc(docRef, { items: [], lastUpdated: new Date() });
                }
                document.getElementById('auth-status').innerText = "Cloud Online";
                const btn = document.getElementById('start-btn');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerText = "Start App";
                updateSyncIcon('ready');
            });
        });

        async function syncToCloud(newData) {
            updateSyncIcon('syncing');
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'records', 'global');
            await setDoc(docRef, { items: newData, lastUpdated: new Date() });
            updateSyncIcon('ready');
        }

        function updateSyncIcon(state) {
            const el = document.getElementById('sync-status');
            if(state === 'syncing') {
                el.innerText = 'SYNCING...';
                el.className = 'sync-indicator bg-amber-50 text-amber-600 mt-1 inline-block';
            } else {
                el.innerText = 'ONLINE';
                el.className = 'sync-indicator bg-emerald-50 text-emerald-600 mt-1 inline-block';
            }
        }

        window.startApp = () => {
            document.getElementById('welcome-screen').style.transform = 'translateY(-100%)';
            setTimeout(() => {
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('main-nav').classList.remove('hidden');
                renderAll();
            }, 500);
        };

        window.toggleFields = () => {
            const cat = document.getElementById('pCategory').value;
            const extraDiv = document.getElementById('perfume-extras');
            extraDiv.style.display = (cat === 'perfume') ? 'grid' : 'none';
            document.getElementById('costLabel').innerText = (cat === 'perfume') ? "·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)" : "·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Total)";
            document.getElementById('saleLabel').innerText = (cat === 'perfume') ? "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)" : "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Total)";
        };

        window.showTab = (tabId) => {
            ['page-input', 'page-daily', 'page-monthly', 'page-calculator'].forEach(p => document.getElementById(p).classList.add('hidden'));
            ['btn-input', 'btn-daily', 'btn-monthly', 'btn-calculator'].forEach(b => document.getElementById(b).classList.remove('active-tab-btn'));
            document.getElementById('page-' + tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('active-tab-btn');
            renderAll();
        };

        window.addSale = async () => {
            const date = document.getElementById('saleDate').value;
            const cat = document.getElementById('pCategory').value;
            const name = document.getElementById('pName').value.trim();
            const costInput = parseFloat(document.getElementById('cPrice').value) || 0;
            const saleInput = parseFloat(document.getElementById('sPrice').value) || 0;
            const risk = parseFloat(document.getElementById('riskMoney').value) || 0;
            const editId = document.getElementById('editId').value;

            if(!name || saleInput <= 0 || !date) return;

            let finalSaleAmt, finalCostAmt, finalName = name, finalSizeLabel = '', pkDeduction = 0;

            if (cat === 'perfume') {
                const type = document.getElementById('pType').value;
                const size = document.getElementById('pSize').value;
                finalName = `${name} (${type})`;
                finalSizeLabel = size;
                
                pkDeduction = (size === 'retail') ? 1000 : 3000;

                if (size === 'retail') {
                    finalSaleAmt = saleInput;
                    finalCostAmt = costInput;
                } else {
                    let ml = 0;
                    if (size === '5ml') ml = 5;
                    else if (size === '10ml') ml = 10;
                    else if (size === '30ml') ml = 30;
                    finalSaleAmt = (saleInput / 100) * ml;
                    finalCostAmt = (costInput / 100) * ml;
                }
            } else {
                finalSaleAmt = saleInput;
                finalCostAmt = costInput;
                finalSizeLabel = cat.toUpperCase();
                pkDeduction = 0; 
            }

            const dailyProfit = (finalSaleAmt - finalCostAmt - pkDeduction) + risk;
            const rawProfit = (finalSaleAmt - finalCostAmt) + risk;

            const itemObj = {
                id: editId ? parseInt(editId) : Date.now(),
                date, name: finalName, size: finalSizeLabel,
                calcCost: finalCostAmt, 
                profit: dailyProfit, 
                rawProfit: rawProfit, 
                riskMoney: risk,
                rawInputs: { cost: costInput, sale: saleInput, cat, size: finalSizeLabel }
            };

            let updated;
            if (editId) {
                updated = salesData.map(item => item.id == editId ? itemObj : item);
                cancelEdit();
            } else {
                updated = [...salesData, itemObj];
            }

            await syncToCloud(updated);
            clearFields();
            showTab('daily');
        };

        window.renderAll = () => {
            const targetDate = document.getElementById('viewDate').value;
            const filtered = salesData.filter(item => item.date === targetDate);
            const tbody = document.getElementById('daily-table-body');
            tbody.innerHTML = '';
            
            let dayProfit = 0, dayCost = 0;
            filtered.slice().reverse().forEach(item => {
                dayProfit += item.profit;
                dayCost += item.calcCost;
                tbody.innerHTML += `
                    <tr class="text-[11px] fade-in">
                        <td class="px-6 py-4">
                            <span class="font-bold text-slate-800">${item.name}</span><br>
                            <span class="text-[9px] font-extrabold text-indigo-500 uppercase">${item.size}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="font-black text-slate-900">${format(item.profit)}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="editItem(${item.id})" class="text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg font-bold">Edit</button>
                        </td>
                    </tr>`;
            });

            document.getElementById('day-total-profit').innerText = format(dayProfit) + " Ks";
            document.getElementById('day-total-cost').innerText = format(dayCost) + " Ks";

            const monthlyContainer = document.getElementById('monthly-container');
            monthlyContainer.innerHTML = '';
            const groups = {};
            salesData.forEach(item => {
                const month = item.date.substring(0, 7);
                if(!groups[month]) groups[month] = { rawProfitSum: 0, cost: 0, count: 0 };
                groups[month].rawProfitSum += (item.rawProfit || item.profit);
                groups[month].cost += item.calcCost;
                groups[month].count++;
            });

            Object.keys(groups).sort().reverse().forEach(month => {
                const data = groups[month];
                const deliFee = 50000;
                const packingFeeTotal = 100000; 
                const netProfit = data.rawProfitSum - deliFee - packingFeeTotal;

                monthlyContainer.innerHTML += `
                    <div class="neo-card rounded-[2.5rem] p-8 border-t-[8px] border-slate-900 fade-in">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-lg font-black text-slate-900">${month}</h3>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Monthly Report</p>
                            </div>
                            <span class="bg-slate-900 text-white px-3 py-1 rounded-full text-[9px] font-black">${data.count} SALES</span>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex justify-between text-[11px] font-bold">
                                <span class="text-slate-500 uppercase tracking-tighter">Gross Profit (Pre-deduction)</span>
                                <span class="text-slate-800">${format(data.rawProfitSum)} Ks</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold text-rose-500">
                                <span class="uppercase">Monthly Packing Fee</span>
                                <span>- ${format(packingFeeTotal)} Ks</span>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold text-rose-500">
                                <span class="uppercase">Monthly Deli Fee</span>
                                <span>- ${format(deliFee)} Ks</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <p class="text-[8px] font-bold text-slate-400 uppercase mb-1">Items Total Cost</p>
                                <p class="text-sm font-black text-slate-800">${format(data.cost)}</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-2xl">
                                <p class="text-[8px] font-bold text-indigo-400 uppercase mb-1">Monthly Pure Profit</p>
                                <p class="text-sm font-black text-indigo-600">${format(netProfit)}</p>
                            </div>
                        </div>
                        
                        <div class="pt-5 border-t border-slate-100 flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Net Revenue</span>
                            <span class="text-xl font-black text-indigo-600">${format(netProfit)} Ks</span>
                        </div>
                    </div>`;
            });
        };

        window.editItem = (id) => {
            const item = salesData.find(x => x.id == id);
            if(!item) return;
            document.getElementById('editId').value = item.id;
            document.getElementById('saleDate').value = item.date;
            document.getElementById('pCategory').value = item.rawInputs?.cat || 'perfume';
            toggleFields();
            document.getElementById('pName').value = item.name.split(' (')[0];
            document.getElementById('cPrice').value = item.rawInputs?.cost;
            document.getElementById('sPrice').value = item.rawInputs?.sale;
            document.getElementById('riskMoney').value = item.riskMoney;
            document.getElementById('input-title').innerText = "‚úèÔ∏è ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫";
            document.getElementById('save-btn').innerText = "Update Record";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            showTab('input');
        };

        window.cancelEdit = () => {
            document.getElementById('editId').value = '';
            document.getElementById('input-title').innerText = "üìù ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏";
            document.getElementById('save-btn').innerText = "·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            clearFields();
        };

        window.clearAllData = async () => {
            if(confirm("·Äí·Ä±·Äê·Ä¨·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äõ·Äî·Ä∫ ·Äû·Ä±·ÄÅ·Äª·Ä¨·Äï·Ä´·Äû·Äú·Ä¨·Ä∏?")) {
                await syncToCloud([]);
            }
        };

        window.calculateQuick = () => {
            const cat = document.getElementById('calcCategory').value;
            const cost = parseFloat(document.getElementById('calcCost').value) || 0;
            const sale = parseFloat(document.getElementById('calcSale').value) || 0;
            const risk = parseFloat(document.getElementById('calcRisk').value) || 0;
            let res = 0;
            if (cat === 'perfume') {
                const sz = document.getElementById('calcSize').value;
                let pk = (sz === 'retail') ? 1000 : 3000; 
                let s, c;
                if (sz === '5ml') { s=(sale/100)*5; c=(cost/100)*5; }
                else if (sz === '10ml') { s=(sale/100)*10; c=(cost/100)*10; }
                else if (sz === '30ml') { s=(sale/100)*30; c=(cost/100)*30; }
                else { s=sale; c=cost; }
                res = (s-c-pk)+risk;
            } else { res = (sale-cost)+risk; }
            document.getElementById('calc-display').classList.remove('hidden');
            document.getElementById('calc-result-text').innerText = format(res) + " Ks";
        };

        window.resetCalc = () => {
            document.getElementById('calcCost').value='';
            document.getElementById('calcSale').value='';
            document.getElementById('calcRisk').value='0';
            document.getElementById('calc-display').classList.add('hidden');
        };

        window.format = (n) => new Intl.NumberFormat('en-US').format(Math.round(n));
        window.clearFields = () => {
            document.getElementById('pName').value = '';
            document.getElementById('cPrice').value = '';
            document.getElementById('sPrice').value = '';
            document.getElementById('riskMoney').value = '0';
        };

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('saleDate').value = today;
        document.getElementById('viewDate').value = today;
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-date').innerText = now.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}).toUpperCase();
        }, 1000);
    </script>
</body>
</html>
