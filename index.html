<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velvet House - Business Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Pyidaungsu:wght@400;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', 'Pyidaungsu', sans-serif; 
            background-color: #fcfcfd; 
            -webkit-tap-highlight-color: transparent;
        }

        .neo-card {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.02), 0 4px 6px -4px rgba(0, 0, 0, 0.02);
        }

        .bottom-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid #f1f5f9;
        }

        .active-tab-btn {
            color: #4f46e5;
        }

        .input-field {
            width: 100% !important;
            max-width: 100% !important;
            display: block !important;
            box-sizing: border-box !important;
            appearance: none;
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            border-color: #4f46e5 !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
        }

        .calc-result {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        #welcome-screen {
            background: radial-gradient(circle at top right, #6366f1, #4338ca);
        }

        .sync-indicator {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 99px;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="pb-28">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center text-center p-8 transition-transform duration-500">
        <div class="w-24 h-24 bg-white/20 backdrop-blur-xl rounded-[40px] flex items-center justify-center mb-8 shadow-2xl border border-white/30">
            <span class="text-4xl font-black text-white">V</span>
        </div>
        <h1 class="text-4xl font-extrabold text-white mb-4 tracking-tight">Velvet House</h1>
        <p class="text-indigo-100 text-sm mb-12 max-w-[250px] leading-relaxed opacity-80">Perfume & Cosmetics Business Management Suite</p>
        <div id="auth-status" class="text-white text-xs mb-4 opacity-70">Connecting to cloud...</div>
        <button id="start-btn" disabled onclick="startApp()" class="w-full max-w-xs bg-white text-indigo-600 font-bold py-5 rounded-3xl shadow-2xl active:scale-95 transition-all text-lg opacity-50 cursor-not-allowed">
            Loading Data...
        </button>
    </div>

    <header id="main-header" class="hidden sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-100 px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-lg font-extrabold text-slate-900 flex items-center gap-2">
                <span class="w-2 h-6 bg-indigo-600 rounded-full"></span>
                Velvet House
            </h1>
            <div id="sync-status" class="sync-indicator bg-amber-50 text-amber-600 mt-1">Cloud Syncing...</div>
        </div>
        <div id="live-date" class="text-[10px] font-bold text-slate-400 uppercase bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100 shadow-sm"></div>
    </header>

    <main id="main-content" class="hidden max-w-md mx-auto p-5 space-y-6">
        
        <!-- Tab 1: Input -->
        <section id="page-input" class="space-y-5">
            <div class="neo-card rounded-3xl p-6 border-b-4 border-indigo-600">
                <h2 id="input-title" class="text-sm font-bold text-slate-800 mb-6 flex items-center gap-2">üìù ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏</h2>

                <div class="space-y-4">
                    <input type="hidden" id="editId">
                    <div class="w-full">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Äî·Ä±·Ä∑·ÄÖ·ÄΩ·Ä≤</label>
                        <input type="date" id="saleDate" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none">
                    </div>

                    <div class="w-full">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏</label>
                        <select id="pCategory" onchange="toggleFields()" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none appearance-none">
                            <option value="perfume">Perfume</option>
                            <option value="cosmetic">Cosmetic</option>
                            <option value="other">Other Item</option>
                        </select>
                    </div>

                    <div class="w-full">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Ä°·Äô·Ää·Ä∫</label>
                        <input type="text" id="pName" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none" placeholder="·Ä°·Äô·Ää·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´">
                    </div>

                    <div id="perfume-extras" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Concentration</label>
                            <select id="pType" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none appearance-none">
                                <option value="EDT">EDT</option>
                                <option value="EDP">EDP</option>
                                <option value="Extrait">Extrait</option>
                                <option value="Parfum">Parfum</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">·ÄÜ·Ä≠·ÄØ·Äí·Ä∫ (Size)</label>
                            <select id="pSize" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none appearance-none">
                                <option value="retail">Retail Box</option>
                                <option value="5ml">5ml Decant</option>
                                <option value="10ml">10ml Decant</option>
                                <option value="30ml">30ml Decant</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label id="costLabel" class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="cPrice" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none" placeholder="0">
                        </div>
                        <div>
                            <label id="saleLabel" class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="sPrice" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none" placeholder="0">
                        </div>
                    </div>

                    <div class="w-full">
                        <label class="text-[10px] font-bold text-indigo-500 uppercase ml-1">Risk Cover Money (·Ä°·Äï·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±)</label>
                        <input type="number" id="riskMoney" class="input-field mt-1 bg-indigo-50/50 border border-indigo-100 rounded-2xl px-4 py-3 outline-none font-bold text-indigo-600" value="0">
                    </div>

                    <div class="flex gap-2">
                         <button id="save-btn" onclick="addSale()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition-all mt-4">
                            ·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫
                        </button>
                        <button id="cancel-edit-btn" onclick="cancelEdit()" class="hidden w-1/3 bg-slate-200 text-slate-600 font-bold py-4 rounded-2xl active:scale-95 transition-all mt-4">
                            ·Äô·Äï·Äº·ÄÑ·Ä∫·Äê·Ä±·Ä¨·Ä∑·Äï·Ä´
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab 2: Stats -->
        <section id="page-daily" class="hidden space-y-4">
            <div class="neo-card p-4 rounded-3xl flex items-center justify-between gap-4">
                <span class="text-[10px] font-bold text-slate-400 uppercase">·Äî·Ä±·Ä∑·Äõ·ÄÄ·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´:</span>
                <input type="date" id="viewDate" onchange="renderAll()" class="bg-slate-50 border-none text-xs font-bold rounded-xl px-4 py-2 outline-none text-indigo-600">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="neo-card p-5 rounded-3xl bg-indigo-600 text-white border-none shadow-indigo-200 shadow-lg">
                    <p class="text-[9px] font-bold uppercase opacity-70 mb-1">·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨·Äõ·ÄÄ·Ä∫·Ä°·Äô·Äº·Äê·Ä∫</p>
                    <h3 class="text-xl font-extrabold" id="day-total-profit">0</h3>
                </div>
                <div class="neo-card p-5 rounded-3xl border-l-4 border-emerald-500">
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äõ·ÄÑ·Ä∫·Ä∏·Äî·Äæ·ÄÆ·Ä∏·ÄÑ·ÄΩ·Ä±</p>
                    <h3 class="text-xl font-extrabold text-slate-800" id="day-total-cost">0</h3>
                </div>
            </div>

            <div class="neo-card rounded-3xl overflow-hidden">
                <div class="px-5 py-4 border-b bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase">·Äî·Ä±·Ä∑·ÄÖ·Äâ·Ä∫·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏</h3>
                    <div class="flex items-center gap-2">
                         <button onclick="clearAllData()" class="text-[8px] bg-rose-50 text-rose-500 px-2 py-1 rounded-lg border border-rose-100 font-bold uppercase">Clear All Data</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left whitespace-nowrap">
                        <thead class="text-[9px] font-bold text-slate-400 uppercase bg-slate-50/50">
                            <tr>
                                <th class="px-5 py-3">·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏</th>
                                <th class="px-5 py-3 text-right">·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏</th>
                                <th class="px-5 py-3 text-right">·Ä°·Äô·Äº·Äê·Ä∫</th>
                                <th class="px-5 py-3 text-center">·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫</th>
                            </tr>
                        </thead>
                        <tbody id="daily-table-body" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab 3: Monthly -->
        <section id="page-monthly" class="hidden space-y-5">
            <div id="monthly-container" class="space-y-6"></div>
        </section>

        <!-- Tab 4: Calculator -->
        <section id="page-calculator" class="hidden space-y-5">
            <div class="neo-card rounded-3xl p-6 border-b-4 border-emerald-500">
                <h2 class="text-sm font-bold text-slate-800 mb-6 flex items-center gap-2">üßÆ ·Ä°·Äô·Äº·Äî·Ä∫·Äê·ÄΩ·ÄÄ·Ä∫·ÄÖ·ÄÄ·Ä∫ (Result Only)</h2>
                <div class="space-y-4">
                    <div class="w-full">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏</label>
                        <select id="calcCategory" onchange="toggleCalcFields()" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none appearance-none">
                            <option value="perfume">Perfume</option>
                            <option value="cosmetic">Cosmetic</option>
                            <option value="other">Other Item</option>
                        </select>
                    </div>
                    <div id="calc-perfume-extras" class="w-full">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">·ÄÜ·Ä≠·ÄØ·Äí·Ä∫ (Size)</label>
                        <select id="calcSize" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none appearance-none">
                            <option value="retail">Retail Box</option>
                            <option value="5ml">5ml Decant</option>
                            <option value="10ml">10ml Decant</option>
                            <option value="30ml">30ml Decant</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label id="calcCostLabel" class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="calcCost" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none" placeholder="0">
                        </div>
                        <div>
                            <label id="calcSaleLabel" class="text-[10px] font-bold text-slate-400 uppercase ml-1">·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)</label>
                            <input type="number" id="calcSale" class="input-field mt-1 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 outline-none" placeholder="0">
                        </div>
                    </div>
                    <div class="w-full">
                        <label class="text-[10px] font-bold text-indigo-500 uppercase ml-1">Risk Cover Money (·Ä°·Äï·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±)</label>
                        <input type="number" id="calcRisk" class="input-field mt-1 bg-indigo-50 border border-indigo-100 rounded-2xl px-4 py-3 outline-none font-bold text-indigo-600" value="0">
                    </div>
                    <div id="calc-display" class="hidden calc-result rounded-2xl p-5 mt-4 text-center">
                        <p class="text-[10px] font-bold uppercase opacity-80 mb-1">·ÄÅ·Äî·Ä∑·Ä∫·Äô·Äæ·Äî·Ä∫·Ä∏·Ä°·Äô·Äº·Äê·Ä∫·Äõ·Äú·Äí·Ä∫</p>
                        <h2 class="text-2xl font-black" id="calc-result-text">0 Ks</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mt-4">
                         <button onclick="calculateQuick()" class="bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">·Äê·ÄΩ·ÄÄ·Ä∫·Äô·Ää·Ä∫</button>
                         <button onclick="resetCalc()" class="bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl active:scale-95 transition-all">Clear</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Nav -->
    <nav id="main-nav" class="hidden fixed bottom-0 left-0 right-0 bottom-nav z-50 px-6 py-4 flex justify-between max-w-md mx-auto">
        <button onclick="showTab('input')" id="btn-input" class="flex flex-col items-center gap-1 active-tab-btn">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            <span class="text-[8px] font-bold uppercase">Input</span>
        </button>
        <button onclick="showTab('daily')" id="btn-daily" class="flex flex-col items-center gap-1 text-slate-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            <span class="text-[8px] font-bold uppercase">Stats</span>
        </button>
        <button onclick="showTab('monthly')" id="btn-monthly" class="flex flex-col items-center gap-1 text-slate-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="text-[8px] font-bold uppercase">Monthly</span>
        </button>
        <button onclick="showTab('calculator')" id="btn-calculator" class="flex flex-col items-center gap-1 text-slate-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            <span class="text-[8px] font-bold uppercase">Calc</span>
        </button>
    </nav>

    <!-- Cloud Core Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG INTEGRATION (Using your provided API Key)
        const firebaseConfig = {
            apiKey: "AIzaSyCZtpVewHYE5SHgmdSHUDYiMeuD9XuM8-Y",
            authDomain: "velvet-house.firebaseapp.com",
            projectId: "velvet-house",
            storageBucket: "velvet-house.firebasestorage.app",
            messagingSenderId: "909921771030",
            appId: "1:909921771030:web:399d30d6912a3685a59f37"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'velvet-house-v17';
        
        // Init
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let salesData = [];
        let user = null;
        const INITIAL_PACK_FEE = 100000;
        const FIXED_DELI_FEE = 100000;

        // Start App
        window.startApp = () => {
            const screen = document.getElementById('welcome-screen');
            screen.style.transform = 'translateY(-100%)';
            setTimeout(() => {
                screen.style.display = 'none';
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('main-nav').classList.remove('hidden');
            }, 500);
        };

        // Sync Indicator
        const updateSyncStatus = (status) => {
            const el = document.getElementById('sync-status');
            if (status === 'syncing') {
                el.innerText = 'Cloud Syncing...';
                el.className = 'sync-indicator bg-amber-50 text-amber-600 mt-1';
            } else if (status === 'success') {
                el.innerText = 'Cloud Updated';
                el.className = 'sync-indicator bg-emerald-50 text-emerald-600 mt-1';
            } else {
                el.innerText = 'Cloud Offline';
                el.className = 'sync-indicator bg-rose-50 text-rose-600 mt-1';
            }
        };

        // Auth & Listener
        signInAnonymously(auth).catch(console.error);

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('auth-status').innerText = "Cloud Connected";
                const startBtn = document.getElementById('start-btn');
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtn.innerText = "Get Started";
                
                // Using standard collection path as per developer instructions
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'data');
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        salesData = docSnap.data().items || [];
                        renderAll();
                        updateSyncStatus('success');
                    } else {
                        saveToCloud([]);
                        updateSyncStatus('success');
                    }
                }, (err) => {
                    updateSyncStatus('error');
                });
            }
        });

        // Save
        async function saveToCloud(newData) {
            if (!user) return;
            updateSyncStatus('syncing');
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'data');
                await setDoc(docRef, { items: newData, lastUpdated: new Date().toISOString() });
                updateSyncStatus('success');
            } catch (err) {
                updateSyncStatus('error');
            }
        }

        // Logic
        window.addSale = async () => {
            const date = document.getElementById('saleDate').value;
            const category = document.getElementById('pCategory').value;
            const name = document.getElementById('pName').value.trim();
            const fullCost = parseFloat(document.getElementById('cPrice').value) || 0;
            const fullSales = parseFloat(document.getElementById('sPrice').value) || 0;
            const riskMoney = parseFloat(document.getElementById('riskMoney').value) || 0;
            const editId = document.getElementById('editId').value;

            if(!name || fullSales <= 0 || !date) return;

            let calcSales, calcCost, packing = 0, finalName = name;
            let currentSize = '';
            
            if (category === 'perfume') {
                const type = document.getElementById('pType').value;
                const size = document.getElementById('pSize').value;
                currentSize = size;
                packing = (size === 'retail') ? 1000 : 3000;
                finalName = (name.includes('(')) ? name : `${name} (${type})`;
                if (size === '5ml') { calcSales = (fullSales/100)*5; calcCost = (fullCost/100)*5; }
                else if (size === '10ml') { calcSales = (fullSales/100)*10; calcCost = (fullCost/100)*10; }
                else if (size === '30ml') { calcSales = (fullSales/100)*30; calcCost = (fullCost/100)*30; }
                else { calcSales = fullSales; calcCost = fullCost; }
            } else {
                calcSales = fullSales; calcCost = fullCost;
                currentSize = category.toUpperCase();
            }

            const profit = (calcSales - calcCost - packing) + riskMoney;

            let updatedData;
            if (editId) {
                updatedData = salesData.map(item => {
                    if (item.id == editId) {
                        return { ...item, date, name: finalName, size: currentSize, calcCost, profit, riskMoney, packingCharge: packing, rawInputs: { fullCost, fullSales, category } };
                    }
                    return item;
                });
                cancelEdit();
            } else {
                const newItem = {
                    id: Date.now(),
                    date,
                    name: finalName,
                    size: currentSize,
                    calcCost,
                    profit,
                    riskMoney,
                    packingCharge: packing,
                    rawInputs: { fullCost, fullSales, category }
                };
                updatedData = [...salesData, newItem];
            }

            document.getElementById('viewDate').value = date;
            clearFields();
            await saveToCloud(updatedData);
        };

        window.editItem = (id) => {
            const item = salesData.find(i => i.id == id);
            if (!item) return;

            document.getElementById('editId').value = item.id;
            document.getElementById('saleDate').value = item.date;
            
            const category = item.rawInputs?.category || (item.size.length > 5 ? 'perfume' : 'other');
            document.getElementById('pCategory').value = category;
            toggleFields();

            document.getElementById('pName').value = item.name.split(' (')[0];
            document.getElementById('cPrice').value = item.rawInputs?.fullCost || item.calcCost;
            document.getElementById('sPrice').value = item.rawInputs?.fullSales || (item.profit + item.calcCost + (item.packingCharge || 0) - item.riskMoney);
            document.getElementById('riskMoney').value = item.riskMoney;

            if (category === 'perfume') {
                document.getElementById('pSize').value = item.size;
                const match = item.name.match(/\((.*?)\)/);
                if (match) document.getElementById('pType').value = match[1];
            }

            document.getElementById('input-title').innerText = "‚úèÔ∏è ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫";
            document.getElementById('save-btn').innerText = "·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            showTab('input');
        };

        window.cancelEdit = () => {
            document.getElementById('editId').value = '';
            document.getElementById('input-title').innerText = "üìù ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏";
            document.getElementById('save-btn').innerText = "·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äô·Ää·Ä∫";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            clearFields();
        };

        window.clearAllData = async () => {
            if(confirm("·Äû·Ä±·ÄÅ·Äª·Ä¨·Äï·Ä´·Äû·Äú·Ä¨·Ä∏? ·Äí·Ä±·Äê·Ä¨·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏ ·Äï·Äª·ÄÄ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äï·Ä´·Äú·Ä≠·Äô·Ä∑·Ä∫·Äô·Ää·Ä∫·Åã")) {
                await saveToCloud([]);
            }
        };

        // Render UI
        window.renderAll = () => {
            const targetDate = document.getElementById('viewDate').value;
            const filteredData = salesData.filter(i => i.date === targetDate);
            
            const tbody = document.getElementById('daily-table-body');
            tbody.innerHTML = '';
            let dProfit = 0, dCost = 0;
            
            filteredData.slice().reverse().forEach(item => {
                dProfit += item.profit;
                dCost += item.calcCost;
                tbody.innerHTML += `
                    <tr class="text-[11px]">
                        <td class="px-5 py-4">
                            <div class="font-bold text-slate-800">${item.name}</div>
                            <div class="text-[8px] text-indigo-500 uppercase">${item.size}</div>
                        </td>
                        <td class="px-5 py-4 text-right text-slate-500">${format(item.calcCost)}</td>
                        <td class="px-5 py-4 text-right font-bold text-slate-900">${format(item.profit)}</td>
                        <td class="px-5 py-4 text-center">
                            <button onclick="editItem(${item.id})" class="text-indigo-600 font-bold px-3 py-1 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors">Edit</button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('day-total-profit').innerText = format(dProfit) + " Ks";
            document.getElementById('day-total-cost').innerText = format(dCost) + " Ks";

            const mContainer = document.getElementById('monthly-container');
            mContainer.innerHTML = '';
            const months = {};
            salesData.forEach(item => {
                const mKey = item.date.substring(0, 7);
                if(!months[mKey]) months[mKey] = { profit: 0, cost: 0, count: 0, totalPacking: 0 };
                months[mKey].profit += item.profit;
                months[mKey].cost += item.calcCost;
                months[mKey].count++;
                months[mKey].totalPacking += (item.packingCharge || 0);
            });

            Object.keys(months).sort().reverse().forEach(m => {
                const data = months[m];
                const remPack = INITIAL_PACK_FEE - data.totalPacking;
                const final = data.profit - INITIAL_PACK_FEE - FIXED_DELI_FEE;
                mContainer.innerHTML += `
                    <div class="neo-card rounded-3xl p-6 border-t-8 border-slate-900">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-lg">${m}</h3>
                            <span class="text-[9px] bg-slate-100 px-2 py-1 rounded-full">${data.count} Sales</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-slate-50 p-3 rounded-2xl">
                                <p class="text-[8px] font-bold text-slate-400 uppercase">·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏</p>
                                <p class="text-sm font-bold">${format(data.cost)}</p>
                            </div>
                            <div class="bg-indigo-50 p-3 rounded-2xl">
                                <p class="text-[8px] font-bold text-indigo-400 uppercase">·Ä°·Äô·Äº·Äê·Ä∫</p>
                                <p class="text-sm font-bold text-indigo-700">${format(data.profit)}</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-[10px] border-t pt-4">
                            <div class="flex justify-between text-slate-400">
                                <span>Packing Budget (Balance)</span>
                                <span class="font-bold text-slate-700">${format(remPack)} Ks</span>
                            </div>
                            <div class="flex justify-between text-slate-400">
                                <span>Deli Fees</span>
                                <span>-${format(FIXED_DELI_FEE)}</span>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t mt-3">
                                <span class="text-xs font-bold text-slate-800">Net Profit</span>
                                <span class="text-xl font-black text-indigo-600">${format(final)} Ks</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        };

        // Helpers
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('saleDate').value = today;
        document.getElementById('viewDate').value = today;

        window.format = (n) => new Intl.NumberFormat('en-US').format(Math.round(n));
        window.clearFields = () => {
            document.getElementById('pName').value = '';
            document.getElementById('cPrice').value = '';
            document.getElementById('sPrice').value = '';
            document.getElementById('riskMoney').value = '0';
        };

        window.toggleFields = () => {
            const cat = document.getElementById('pCategory').value;
            const extra = document.getElementById('perfume-extras');
            const costL = document.getElementById('costLabel');
            const saleL = document.getElementById('saleLabel');
            if (cat === 'perfume') {
                extra.style.display = 'grid';
                costL.innerText = "·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)";
                saleL.innerText = "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)";
            } else {
                extra.style.display = 'none';
                costL.innerText = "·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Total)";
                saleL.innerText = "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Total)";
            }
        };

        window.showTab = (tab) => {
            ['page-input', 'page-daily', 'page-monthly', 'page-calculator'].forEach(p => document.getElementById(p).classList.add('hidden'));
            ['btn-input', 'btn-daily', 'btn-monthly', 'btn-calculator'].forEach(b => {
                document.getElementById(b).classList.remove('active-tab-btn');
                document.getElementById(b).classList.add('text-slate-400');
            });
            document.getElementById('page-' + tab).classList.remove('hidden');
            document.getElementById('btn-' + tab).classList.add('active-tab-btn');
            renderAll();
        };

        window.toggleCalcFields = () => {
            const cat = document.getElementById('calcCategory').value;
            const extras = document.getElementById('calc-perfume-extras');
            const cl = document.getElementById('calcCostLabel');
            const sl = document.getElementById('calcSaleLabel');
            if(cat === 'perfume') {
                extras.classList.remove('hidden');
                cl.innerText = "·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)";
                sl.innerText = "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (100ml)";
            } else {
                extras.classList.add('hidden');
                cl.innerText = "·Äõ·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Total)";
                sl.innerText = "·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Total)";
            }
        };

        window.calculateQuick = () => {
            const cat = document.getElementById('calcCategory').value;
            const cost = parseFloat(document.getElementById('calcCost').value) || 0;
            const sale = parseFloat(document.getElementById('calcSale').value) || 0;
            const risk = parseFloat(document.getElementById('calcRisk').value) || 0;
            let res = 0;
            if (cat === 'perfume') {
                const sz = document.getElementById('calcSize').value;
                let pk = (sz === 'retail') ? 1000 : 3000;
                let s, c;
                if (sz === '5ml') { s=(sale/100)*5; c=(cost/100)*5; }
                else if (sz === '10ml') { s=(sale/100)*10; c=(cost/100)*10; }
                else if (sz === '30ml') { s=(sale/100)*30; c=(cost/100)*30; }
                else { s=sale; c=cost; }
                res = (s-c-pk)+risk;
            } else { res = (sale-cost)+risk; }
            document.getElementById('calc-display').classList.remove('hidden');
            document.getElementById('calc-result-text').innerText = format(res) + " Ks";
        };

        window.resetCalc = () => {
            document.getElementById('calcCost').value='';
            document.getElementById('calcSale').value='';
            document.getElementById('calcRisk').value='0';
            document.getElementById('calc-display').classList.add('hidden');
        };

        // Date Display
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-date').innerText = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }, 1000);
    </script>
</body>
</html>
